# Caddyfile for Troy Vape — ecossistematroy.com
# Caddy automatically provisions Let's Encrypt HTTPS certificates
#
# Auth strategy: cookie-based session gate.
# /login serves the login page, /api/auth/verify checks credentials.
# All other routes require a troy_session cookie — without it, redirect to /login.

ecossistematroy.com {
    # Use route for explicit ordering (first match wins)
    route {
        # 1. Serve login page (no auth required)
        handle /login {
            root * /srv
            rewrite * /login.html
            file_server
        }

        # 2. Auth verification endpoint — validates credentials via basic_auth
        handle /api/auth/verify {
            basic_auth {
                NettoManoel $2a$14$apFLzDbn3aZUkUG0w7t2Veo2K2d028lQeooRpoisB4rDtuOThbb0.
            }
            respond "OK" 200
        }

        # 3. No session cookie → redirect to login
        @noSession {
            not header_regexp Cookie troy_session=authenticated
        }
        handle @noSession {
            redir /login 302
        }

        # 4. Authenticated → proxy to gateway
        reverse_proxy openclaw-gateway:18789
    }
}

www.ecossistematroy.com {
    redir https://ecossistematroy.com{uri} permanent
}
