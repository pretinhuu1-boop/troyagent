# Caddyfile for Troy Vape — ecossistematroy.com
# Caddy automatically provisions Let's Encrypt HTTPS certificates
#
# Auth strategy: login page as visual gate → credentials verified via
# basic_auth on /api/auth/verify only → app routes are open reverse_proxy.
# Real auth is the gateway token (OPENCLAW_GATEWAY_TOKEN).

ecossistematroy.com {
    # Serve login page (no auth required)
    @login path /login
    handle @login {
        root * /srv
        rewrite * /login.html
        file_server
    }

    # Serve static assets for login page (CSS, images, etc.)
    @static path /static/*
    handle @static {
        root * /srv
        file_server
    }

    # Auth verification endpoint — validates credentials via basic_auth
    @verify path /api/auth/verify
    handle @verify {
        basic_auth {
            NettoManoel $2a$14$apFLzDbn3aZUkUG0w7t2Veo2K2d028lQeooRpoisB4rDtuOThbb0.
        }
        respond "OK" 200
    }

    # Check auth cookie — if no session cookie, redirect to login
    # Uses a simple cookie-based approach: login.html sets a cookie after
    # successful verification, Caddy checks it exists on all other routes
    @noSession {
        not path /login
        not path /api/auth/verify
        not path /static/*
        not header_regexp Cookie troy_session=authenticated
    }
    handle @noSession {
        redir /login 302
    }

    # All authenticated requests: proxy to gateway
    handle {
        reverse_proxy openclaw-gateway:18789
    }
}

www.ecossistematroy.com {
    redir https://ecossistematroy.com{uri} permanent
}
