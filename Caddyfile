# Caddyfile for Troy Vape — ecossistematroy.com
# Auth: cookie-based session gate + basic_auth on verify endpoint only.

ecossistematroy.com {
    # Login page — always accessible, no auth
    handle /login {
        root * /srv
        rewrite * /login.html
        file_server
    }

    # Auth verify — validates credentials, returns 200 on success
    handle /api/auth/verify {
        basic_auth {
            NettoManoel $2a$14$apFLzDbn3aZUkUG0w7t2Veo2K2d028lQeooRpoisB4rDtuOThbb0.
        }
        respond "OK" 200
    }

    # Authenticated users (have session cookie) → proxy to gateway
    @hasSession header_regexp session Cookie troy_session=authenticated
    handle @hasSession {
        reverse_proxy openclaw-gateway:18789
    }

    # Everyone else → redirect to login
    handle {
        redir /login 302
    }
}

www.ecossistematroy.com {
    redir https://ecossistematroy.com{uri} permanent
}
