# Caddyfile for Troy Vape — ecossistematroy.com
# Caddy automatically provisions Let's Encrypt HTTPS certificates

ecossistematroy.com {
    # Serve login page without auth
    @login path /login
    handle @login {
        root * /srv
        rewrite * /login.html
        file_server
    }

    # Auth verification endpoint — validates credentials
    @verify path /api/auth/verify
    handle @verify {
        basic_auth {
            NettoManoel $2a$14$apFLzDbn3aZUkUG0w7t2Veo2K2d028lQeooRpoisB4rDtuOThbb0.
        }
        respond "OK" 200
    }

    # WebSocket connections — gateway handles its own token auth
    @websocket {
        header Connection *Upgrade*
        header Upgrade websocket
    }
    handle @websocket {
        reverse_proxy openclaw-gateway:18789
    }

    # All other requests: if no Authorization header, redirect to login
    @noAuth {
        not header Authorization *
    }
    handle @noAuth {
        redir /login 302
    }

    # Authenticated requests: validate and proxy
    handle {
        basic_auth {
            NettoManoel $2a$14$apFLzDbn3aZUkUG0w7t2Veo2K2d028lQeooRpoisB4rDtuOThbb0.
        }
        reverse_proxy openclaw-gateway:18789
    }
}

www.ecossistematroy.com {
    redir https://ecossistematroy.com{uri} permanent
}
